import 'package:isar/isar.dart';
import 'package:path_provider/path_provider.dart';

import '../models/chess_game.dart';
import '../models/player.dart';

class ChessGameStorageService {
  // static final ChessGameStorageService _instance =
  //     ChessGameStorageService._internal();

  // factory ChessGameStorageService() => _instance;
  // ChessGameStorageService._internal();

  // static late Isar db;
  static late final Isar db;

  /// âœ… ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  static Future<void> init() async {
    // if (_isar != null) return;
    final dir = await getApplicationSupportDirectory();

    db = await Isar.open(
      [PlayerSchema, ChessGameSchema], // Schemas generated by build_runner
      directory: dir.path,
      inspector: true,
    );
  }

  Isar get isar {
    return db;
  }

  // ğŸ§© Ø­ÙØ¸ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø¹Ø¨
  Future<Player> upsertPlayer(Player player) async {
    await isar.writeTxn(() async {
      await isar.players.put(player);
    });
    return player;
  }

  // ğŸ§© Ø¬Ù„Ø¨ Ù„Ø§Ø¹Ø¨ Ø­Ø³Ø¨ uuid
  Future<Player?> getPlayerByUuid(String uuid) async {
    return await isar.players.filter().uuidEqualTo(uuid).findFirst();
  }

  // ğŸ§© Ø­ÙØ¸ Ù„Ø¹Ø¨Ø© Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
  Future<ChessGame> saveGame(ChessGame game, Player white, Player black) async {
    await isar.writeTxn(() async {
      await isar.players.putAll([white, black]);
      game.whitePlayer.value = white;
      game.blackPlayer.value = black;
      await isar.chessGames.put(game);
      await game.whitePlayer.save();
      await game.blackPlayer.save();
    });
    return game;
  }

  // ğŸ§© Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø¨ØªØ±ØªÙŠØ¨ Ø²Ù…Ù†ÙŠ ØªÙ†Ø§Ø²Ù„ÙŠ
  Future<List<ChessGame>> getAllGames() async {
    final games = await isar.chessGames.where().sortByDateDesc().findAll();
    for (final g in games) {
      await g.whitePlayer.load();
      await g.blackPlayer.load();
    }
    return games;
  }

  // ğŸ§© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨
  Future<List<ChessGame>> getGamesByPlayer(String uuid) async {
    final player = await getPlayerByUuid(uuid);
    if (player == null) return [];
    final games =
        await isar.chessGames
            .filter()
            .group(
              (q) => q
                  .whitePlayer((w) => w.uuidEqualTo(uuid))
                  .or()
                  .blackPlayer((b) => b.uuidEqualTo(uuid)),
            )
            .findAll();

    for (final g in games) {
      await g.whitePlayer.load();
      await g.blackPlayer.load();
    }
    return games;
  }

  // ğŸ§© Ø­Ø°Ù Ù„Ø¹Ø¨Ø©
  Future<void> deleteGame(int id) async {
    await isar.writeTxn(() async {
      await isar.chessGames.delete(id);
    });
  }

  // ğŸ§© Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
  Future<void> clearAll() async {
    await isar.writeTxn(() async {
      await isar.chessGames.clear();
      await isar.players.clear();
    });
  }
}
